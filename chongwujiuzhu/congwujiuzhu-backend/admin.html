<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å® ç‰©æ•‘åŠ©ç®¡ç†åå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #ea580c;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg z-10 flex flex-col">
        <div class="p-6 border-b border-gray-100">
            <h1 class="text-2xl font-bold text-orange-600 flex items-center gap-2">
                ğŸ¾ æ•‘åŠ©ç®¡ç†
            </h1>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('dashboard')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-orange-50 hover:text-orange-600 transition flex items-center gap-3 font-medium text-gray-600" data-tab="dashboard">
                ğŸ“Š æ•°æ®æ¦‚è§ˆ
            </button>
            <button onclick="switchTab('pets')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-orange-50 hover:text-orange-600 transition flex items-center gap-3 font-medium text-gray-600" data-tab="pets">
                ğŸ¶ æ•‘åŠ©ä¿¡æ¯
            </button>
            <button onclick="switchTab('dailies')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-orange-50 hover:text-orange-600 transition flex items-center gap-3 font-medium text-gray-600" data-tab="dailies">
                ğŸ“ æ—¥å¸¸æ›´æ–°
            </button>
            <button onclick="switchTab('comments')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-orange-50 hover:text-orange-600 transition flex items-center gap-3 font-medium text-gray-600" data-tab="comments">
                ğŸ’¬ è¯„è®ºç®¡ç†
            </button>
            <button onclick="switchTab('users')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-orange-50 hover:text-orange-600 transition flex items-center gap-3 font-medium text-gray-600" data-tab="users">
                ğŸ‘¥ ç”¨æˆ·ç®¡ç†
            </button>
            <button onclick="switchTab('settings')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-orange-50 hover:text-orange-600 transition flex items-center gap-3 font-medium text-gray-600" data-tab="settings">
                âš™ï¸ ç³»ç»Ÿè®¾ç½®
            </button>
        </nav>
        <div class="p-4 border-t border-gray-100">
            <div class="flex items-center gap-3 px-4 py-3 mb-2">
                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-sm font-bold text-gray-600" id="adminAvatar">A</div>
                <div class="text-sm font-medium" id="adminName">Admin</div>
            </div>
            <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-red-50 rounded-lg transition">
                é€€å‡ºç™»å½•
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="ml-64 p-8">
        
        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <h2 class="text-2xl font-bold mb-6">æ•°æ®æ¦‚è§ˆ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="text-gray-500 text-sm mb-1">æ€»æ•‘åŠ©ä¿¡æ¯</div>
                    <div class="text-3xl font-bold text-gray-800" id="stat-totalPets">-</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="text-gray-500 text-sm mb-1">å¾…å®¡æ ¸</div>
                    <div class="text-3xl font-bold text-orange-500" id="stat-pendingAudits">-</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="text-gray-500 text-sm mb-1">å·²æ•‘åŠ©</div>
                    <div class="text-3xl font-bold text-green-500" id="stat-rescuedPets">-</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="text-gray-500 text-sm mb-1">æ³¨å†Œç”¨æˆ·</div>
                    <div class="text-3xl font-bold text-blue-500" id="stat-totalUsers">-</div>
                </div>
            </div>
        </div>

        <!-- Pets Management -->
        <div id="pets" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">æ•‘åŠ©ä¿¡æ¯ç®¡ç†</h2>
                <div class="flex gap-2">
                    <select id="petFilter" onchange="loadPets()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="PENDING">å¾…å®¡æ ¸</option>
                        <option value="APPROVED">å·²é€šè¿‡</option>
                        <option value="REJECTED">å·²æ‹’ç»</option>
                    </select>
                    <button onclick="loadPets()" class="bg-white border border-gray-300 px-4 py-2 rounded-lg text-sm hover:bg-gray-50">åˆ·æ–°</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold">
                        <tr>
                            <th class="px-6 py-4">å›¾ç‰‡</th>
                            <th class="px-6 py-4">æè¿°/åœ°ç‚¹</th>
                            <th class="px-6 py-4">å‘å¸ƒäºº</th>
                            <th class="px-6 py-4">çŠ¶æ€</th>
                            <th class="px-6 py-4">å®¡æ ¸</th>
                            <th class="px-6 py-4">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="petsTableBody" class="divide-y divide-gray-100 text-sm">
                        <!-- Rows injected by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dailies Management -->
        <div id="dailies" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">æ—¥å¸¸æ›´æ–°ç®¡ç†</h2>
                <button onclick="loadDailies()" class="bg-white border border-gray-300 px-4 py-2 rounded-lg text-sm hover:bg-gray-50">åˆ·æ–°</button>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold">
                        <tr>
                            <th class="px-6 py-4">å›¾ç‰‡</th>
                            <th class="px-6 py-4">å†…å®¹</th>
                            <th class="px-6 py-4">å…³è”æ•‘åŠ©ä¿¡æ¯</th>
                            <th class="px-6 py-4">å‘å¸ƒäºº</th>
                            <th class="px-6 py-4">æ—¶é—´</th>
                            <th class="px-6 py-4">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="dailiesTableBody" class="divide-y divide-gray-100 text-sm"></tbody>
                </table>
            </div>
        </div>

        <!-- Comments Management -->
        <div id="comments" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">è¯„è®ºç®¡ç†</h2>
                <button onclick="loadComments()" class="bg-white border border-gray-300 px-4 py-2 rounded-lg text-sm hover:bg-gray-50">åˆ·æ–°</button>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold">
                        <tr>
                            <th class="px-6 py-4">è¯„è®ºå†…å®¹</th>
                            <th class="px-6 py-4">å…³è”æ—¥å¸¸</th>
                            <th class="px-6 py-4">å‘å¸ƒäºº</th>
                            <th class="px-6 py-4">æ—¶é—´</th>
                            <th class="px-6 py-4">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="commentsTableBody" class="divide-y divide-gray-100 text-sm"></tbody>
                </table>
            </div>
        </div>

        <!-- Users Management -->
        <div id="users" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">ç”¨æˆ·ç®¡ç†</h2>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold">
                        <tr>
                            <th class="px-6 py-4">å¤´åƒ</th>
                            <th class="px-6 py-4">æ˜µç§°</th>
                            <th class="px-6 py-4">OpenID</th>
                            <th class="px-6 py-4">æ³¨å†Œæ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody" class="divide-y divide-gray-100 text-sm">
                        <!-- Rows injected by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings -->
        <div id="settings" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">ç³»ç»Ÿè®¾ç½®</h2>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 max-w-2xl">
                <form id="settingsForm" onsubmit="saveSettings(event)">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å‘å¸–å®¡æ ¸</label>
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="setting-audit_required" class="w-5 h-5 text-orange-600 rounded focus:ring-orange-500 border-gray-300">
                            <span class="text-gray-600">å¼€å¯å‘å¸–å®¡æ ¸ï¼ˆå¼€å¯åæ–°å¸–éœ€åå°é€šè¿‡æ‰æ˜¾ç¤ºï¼‰</span>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†äº«æ ‡é¢˜æ¨¡æ¿</label>
                        <input type="text" id="setting-share_title_template" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="ä¾‹å¦‚ï¼šã€$çŠ¶æ€ã€‘$åœ°ç‚¹ $æè¿°">
                        <p class="text-xs text-gray-500 mt-2">å¯ç”¨å˜é‡: $çŠ¶æ€, $åœ°ç‚¹, $æè¿°</p>
                    </div>

                    <button type="submit" class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition font-medium">ä¿å­˜è®¾ç½®</button>
                </form>
            </div>
        </div>

    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl max-w-2xl w-full m-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold">è¯¦æƒ…ä¿¡æ¯</h3>
                    <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
                </div>
                <div id="detailContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Auth Check
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/login';
        }
        const user = JSON.parse(localStorage.getItem('adminUser') || '{}');
        document.getElementById('adminName').textContent = user.username || 'Admin';

        // Toast Notification
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? 'âœ“' : 'âœ•';
            
            toast.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] toast-enter`;
            toast.innerHTML = `
                <div class="w-6 h-6 bg-white bg-opacity-20 rounded-full flex items-center justify-center font-bold text-sm">${icon}</div>
                <div class="font-medium">${message}</div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Navigation
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(el => {
                if (el.dataset.tab === tabId) {
                    el.classList.add('bg-orange-50', 'text-orange-600');
                } else {
                    el.classList.remove('bg-orange-50', 'text-orange-600');
                }
            });

            if (tabId === 'dashboard') loadStats();
            if (tabId === 'pets') loadPets();
            if (tabId === 'dailies') loadDailies();
            if (tabId === 'comments') loadComments();
            if (tabId === 'users') loadUsers();
            if (tabId === 'settings') loadSettings();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            window.location.href = '/login';
        }

        // API Helpers
        async function api(endpoint, options = {}) {
            try {
                const res = await fetch(`/api${endpoint}`, options);
                return await res.json();
            } catch (e) {
                console.error(e);
                return { success: false, code: 500, message: 'Network Error' };
            }
        }

        // Dashboard
        async function loadStats() {
            const res = await api('/admin/stats');
            if (res.success) {
                document.getElementById('stat-totalPets').textContent = res.data.totalPets;
                document.getElementById('stat-pendingAudits').textContent = res.data.pendingAudits;
                document.getElementById('stat-rescuedPets').textContent = res.data.rescuedPets;
                document.getElementById('stat-totalUsers').textContent = res.data.totalUsers;
            }
        }

        // Pets
        async function loadPets() {
            const tbody = document.getElementById('petsTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center"><div class="inline-block loading-spinner"></div></td></tr>';
            
            const filter = document.getElementById('petFilter').value;
            const res = await api('/pets');
            tbody.innerHTML = '';

            if (res.code === 200) {
                let pets = res.data;
                if (filter !== 'all') {
                    if (filter === 'PENDING') pets = pets.filter(p => p.auditStatus === 'PENDING');
                    if (filter === 'APPROVED') pets = pets.filter(p => p.auditStatus === 'APPROVED');
                    if (filter === 'REJECTED') pets = pets.filter(p => p.auditStatus === 'REJECTED');
                }

                if (pets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">æš‚æ— æ•°æ®</td></tr>';
                    return;
                }

                pets.forEach(pet => {
                    const tr = document.createElement('tr');
                    const img = pet.images && pet.images.length > 0 ? pet.images[0] : 'https://placehold.co/100';
                    const statusBadge = pet.status === 'RESCUED' 
                        ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">å·²æ•‘åŠ©</span>' 
                        : '<span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs">æ±‚åŠ©ä¸­</span>';
                    
                    let auditBadge = '';
                    if (pet.auditStatus === 'PENDING') auditBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">å¾…å®¡æ ¸</span>';
                    else if (pet.auditStatus === 'APPROVED') auditBadge = '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">å·²é€šè¿‡</span>';
                    else if (pet.auditStatus === 'REJECTED') auditBadge = '<span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">å·²æ‹’ç»</span>';
                    else auditBadge = '<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">æœªçŸ¥</span>';

                    tr.innerHTML = `
                        <td class="px-6 py-4"><img src="${img}" class="w-16 h-16 object-cover rounded-lg bg-gray-100 cursor-pointer" onclick="showDetail('${pet.id}')"></td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900 truncate w-48" title="${pet.description}">${pet.description || 'æ— æè¿°'}</div>
                            <div class="text-xs text-gray-500 mt-1">ğŸ“ ${pet.address || 'æœªçŸ¥ä½ç½®'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <img src="${pet.reporterAvatar || 'https://placehold.co/30'}" class="w-6 h-6 rounded-full">
                                <span class="text-xs">${pet.reporterName || 'åŒ¿å'}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4">${auditBadge}</td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                ${pet.auditStatus === 'PENDING' ? `
                                <button onclick="auditPet('${pet.id}', 'APPROVED')" class="text-green-600 hover:text-green-800 text-xs font-medium">é€šè¿‡</button>
                                <button onclick="auditPet('${pet.id}', 'REJECTED')" class="text-red-600 hover:text-red-800 text-xs font-medium">æ‹’ç»</button>
                                ` : ''}
                                <button onclick="deletePet('${pet.id}')" class="text-gray-400 hover:text-red-600 text-xs">åˆ é™¤</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                showToast('åŠ è½½å¤±è´¥: ' + res.message, 'error');
            }
        }

        // Dailies
        let dailiesData = [];

        async function loadDailies() {
            const tbody = document.getElementById('dailiesTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center"><div class="inline-block loading-spinner"></div></td></tr>';
            
            const res = await api('/admin/dailies');
            tbody.innerHTML = '';

            if (res.success) {
                dailiesData = res.data;
                if (res.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">æš‚æ— æ•°æ®</td></tr>';
                    return;
                }

                res.data.forEach(daily => {
                    const tr = document.createElement('tr');
                    
                    let dailyImg = '';
                    try {
                        let imgs = daily.images;
                        if (typeof imgs === 'string') {
                            imgs = JSON.parse(imgs || '[]');
                        }
                        if (Array.isArray(imgs) && imgs.length > 0) dailyImg = imgs[0];
                    } catch (e) {}
                    
                    const imgHtml = dailyImg ? `<img src="${dailyImg}" class="w-10 h-10 rounded object-cover bg-gray-100 cursor-pointer" onclick="showDailyDetail('${daily.id}')">` : '<div class="w-10 h-10 rounded bg-gray-100 flex items-center justify-center text-gray-400 text-xs">æ— å›¾</div>';

                    tr.innerHTML = `
                        <td class="px-6 py-4">${imgHtml}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900 truncate w-64" title="${daily.content}">${daily.content}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">${daily.petDescription || 'æœªçŸ¥æ•‘åŠ©ä¿¡æ¯'}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${daily.authorName || 'åŒ¿å'}</td>
                        <td class="px-6 py-4 text-xs text-gray-500">${new Date(daily.createdAt).toLocaleString()}</td>
                        <td class="px-6 py-4">
                            <button onclick="deleteDaily('${daily.id}')" class="text-gray-400 hover:text-red-600 text-xs">åˆ é™¤</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                showToast('åŠ è½½å¤±è´¥: ' + res.message, 'error');
            }
        }

        window.showDailyDetail = (id) => {
            const daily = dailiesData.find(d => d.id == id);
            if (!daily) return;

            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailContent');
            
            let images = [];
            try {
                let imgs = daily.images;
                if (typeof imgs === 'string') imgs = JSON.parse(imgs || '[]');
                if (Array.isArray(imgs)) images = imgs;
            } catch (e) {}

            const imagesHtml = images.map(img => 
                `<img src="${img}" class="w-full h-auto rounded-lg mb-2 bg-gray-50 border border-gray-100">`
            ).join('');

            content.innerHTML = `
                <div class="grid grid-cols-1 gap-4 mb-4 max-h-96 overflow-y-auto">
                    ${imagesHtml || '<div class="text-center text-gray-400 py-8">æš‚æ— å›¾ç‰‡</div>'}
                </div>
                <div class="space-y-4">
                    <div>
                        <div class="text-sm text-gray-500 mb-1">å†…å®¹</div>
                        <div class="text-gray-900 bg-gray-50 p-3 rounded-lg">${daily.content}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm text-gray-500 mb-1">å…³è”æ•‘åŠ©ä¿¡æ¯</div>
                            <div class="font-medium">${daily.petDescription || 'æœªçŸ¥'}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 mb-1">å‘å¸ƒäºº</div>
                            <div class="font-medium">${daily.authorName || 'åŒ¿å'}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 mb-1">å‘å¸ƒæ—¶é—´</div>
                            <div class="font-medium">${new Date(daily.createdAt).toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        async function deleteDaily(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥å¸¸å—ï¼Ÿ')) return;
            const res = await fetch(`/api/admin/dailies/${id}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.success) {
                showToast('åˆ é™¤æˆåŠŸ');
                loadDailies();
            } else {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // Comments
        async function loadComments() {
            const tbody = document.getElementById('commentsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center"><div class="inline-block loading-spinner"></div></td></tr>';
            
            const res = await api('/admin/comments');
            tbody.innerHTML = '';

            if (res.success) {
                if (res.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">æš‚æ— æ•°æ®</td></tr>';
                    return;
                }

                res.data.forEach(comment => {
                    const tr = document.createElement('tr');
                    
                    let dailyImg = '';
                    try {
                        let imgs = comment.dailyImages;
                        if (typeof imgs === 'string') {
                            imgs = JSON.parse(imgs || '[]');
                        }
                        if (Array.isArray(imgs) && imgs.length > 0) dailyImg = imgs[0];
                    } catch (e) {
                        console.error('Image parse error:', e);
                    }

                    const imgHtml = dailyImg ? `<img src="${dailyImg}" class="w-10 h-10 rounded object-cover bg-gray-100 flex-shrink-0">` : '<div class="w-10 h-10 rounded bg-gray-100 flex-shrink-0 flex items-center justify-center text-gray-400 text-xs">æ— å›¾</div>';

                    tr.innerHTML = `
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900 truncate w-64" title="${comment.content}">${comment.content}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                ${imgHtml}
                                <div class="min-w-0">
                                    <div class="text-sm text-gray-900 font-medium truncate w-40" title="${comment.petDescription || 'æœªçŸ¥æ•‘åŠ©ä¿¡æ¯'}">${comment.petDescription || 'æœªçŸ¥æ•‘åŠ©ä¿¡æ¯'}</div>
                                    <div class="text-xs text-gray-500 truncate w-40" title="${comment.dailyContent || 'æ— å†…å®¹'}">${comment.dailyContent || 'æ— å†…å®¹'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">${comment.authorName || 'åŒ¿å'}</td>
                        <td class="px-6 py-4 text-xs text-gray-500">${new Date(comment.createdAt).toLocaleString()}</td>
                        <td class="px-6 py-4">
                            <button onclick="deleteComment('${comment.id}')" class="text-gray-400 hover:text-red-600 text-xs">åˆ é™¤</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                showToast('åŠ è½½å¤±è´¥: ' + res.message, 'error');
            }
        }

        async function deleteComment(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;
            const res = await fetch(`/api/admin/comments/${id}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.success) {
                showToast('åˆ é™¤æˆåŠŸ');
                loadComments();
            } else {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        async function auditPet(id, status) {
            if (!confirm(`ç¡®å®šè¦${status === 'APPROVED' ? 'é€šè¿‡' : 'æ‹’ç»'}è¿™æ¡ä¿¡æ¯å—ï¼Ÿ`)) return;
            try {
                const res = await fetch(`/api/audits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        petId: id, 
                        status, 
                        reason: 'åå°å®¡æ ¸',
                        reviewerName: user.username || 'Admin'
                    })
                });
                const result = await res.json();
                if (result.code === 200) {
                    showToast('å®¡æ ¸æ“ä½œæˆåŠŸ');
                    loadPets();
                    loadStats();
                } else {
                    showToast('æ“ä½œå¤±è´¥: ' + result.message, 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        }

        async function deletePet(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ä¿¡æ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            try {
                const res = await fetch(`/api/pets/${id}`, {
                    method: 'DELETE'
                });
                const result = await res.json();
                if (result.code === 200) {
                    showToast('åˆ é™¤æˆåŠŸ');
                    loadPets();
                    loadStats();
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + result.message, 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // Users
        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center"><div class="inline-block loading-spinner"></div></td></tr>';
            
            const res = await api('/users');
            tbody.innerHTML = '';
            
            if (res.code === 200) {
                if (res.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">æš‚æ— ç”¨æˆ·</td></tr>';
                    return;
                }

                res.data.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4"><img src="${user.avatarUrl || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full bg-gray-100"></td>
                        <td class="px-6 py-4 font-medium">${user.nickname || 'æœªå‘½å'}</td>
                        <td class="px-6 py-4 text-gray-500 font-mono text-xs">${user.openId}</td>
                        <td class="px-6 py-4 text-gray-500 text-xs">${new Date(user.created_at).toLocaleString()}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                showToast('åŠ è½½ç”¨æˆ·å¤±è´¥: ' + res.message, 'error');
            }
        }

        // Settings
        async function loadSettings() {
            const res = await api('/admin/settings');
            if (res.success) {
                const settings = res.data;
                document.getElementById('setting-audit_required').checked = settings.audit_required === 'true';
                document.getElementById('setting-share_title_template').value = settings.share_title_template || '';
            }
        }

        async function saveSettings(e) {
            e.preventDefault();
            const settings = {
                audit_required: document.getElementById('setting-audit_required').checked ? 'true' : 'false',
                share_title_template: document.getElementById('setting-share_title_template').value
            };
            
            const res = await fetch('/api/admin/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ settings })
            });
            const result = await res.json();
            if (result.success) {
                showToast('è®¾ç½®å·²ä¿å­˜');
            } else {
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // Detail Modal
        window.showDetail = async (id) => {
            const res = await api(`/pets/${id}`);
            if (res.code === 200) {
                const pet = res.data;
                const modal = document.getElementById('detailModal');
                const content = document.getElementById('detailContent');
                
                const imagesHtml = (pet.images || []).map(img => 
                    `<img src="${img}" class="w-full h-auto rounded-lg mb-2 bg-gray-50 border border-gray-100">`
                ).join('');

                content.innerHTML = `
                    <div class="grid grid-cols-1 gap-4 mb-4 max-h-96 overflow-y-auto">
                        ${imagesHtml}
                    </div>
                    <div class="space-y-4">
                        <div>
                            <span class="text-sm text-gray-500">æè¿°</span>
                            <p class="text-gray-800">${pet.description || 'æ— '}</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">åœ°å€</span>
                            <p class="text-gray-800">${pet.address || 'æ— '}</p>
                        </div>
                        <div class="flex gap-4">
                            <div>
                                <span class="text-sm text-gray-500">çŠ¶æ€</span>
                                <p class="font-medium">${pet.status === 'RESCUED' ? 'å·²æ•‘åŠ©' : 'æ±‚åŠ©ä¸­'}</p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-500">å®¡æ ¸çŠ¶æ€</span>
                                <p class="font-medium">${pet.auditStatus}</p>
                            </div>
                        </div>
                    </div>
                `;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        };

        window.closeDetailModal = () => {
            const modal = document.getElementById('detailModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        // Init
        switchTab('dashboard');

    </script>
</body>
</html>
